name: build_and_release

on:
  push:
    tags: [ 'v*' ]
    branches-ignore: [ '*' ]
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    if: "!contains(github.ref, '-auto')"
    env:
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: 1-CheckoutCode
        uses: actions/checkout@v4

      - name: 2-SetupGoEnv
        uses: actions/setup-go@v4
        with:
          go-version: 1.24.1
          cache: true
          cache-dependency-path: ${{ github.workspace }}/AListLib/sources/go.sum

      - name: 3-SetupJDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: 3.1-CacheGradleDependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.android/build-cache
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: 4-GetLatestTag
        id: get_latest_tag
        run: |
          LATEST_TAG=$(git tag -l "v*" --sort=-v:refname | grep -v ^.*-auto$ | head -n 1)
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°tagï¼Œä»build.gradleè¯»å–ç‰ˆæœ¬å·ä½œä¸ºé»˜è®¤å€¼
          if [ -z "$LATEST_TAG" ]; then
            VERSION_FROM_GRADLE=$(grep -oP 'versionName "\K[^"]+' app/build.gradle)
            LATEST_TAG="v${VERSION_FROM_GRADLE}"
            echo "âš ï¸ No tags found in repository!"
            echo "ğŸ“¦ Using version from build.gradle as default: $LATEST_TAG"
            echo "ğŸ’¡ Tip: Create a tag with: git tag $LATEST_TAG && git push origin $LATEST_TAG"
          else
            echo "âœ… Found latest tag: $LATEST_TAG"
          fi
          NEW_TAG="${LATEST_TAG}-auto"
          echo "ğŸ·ï¸ New tag will be: $NEW_TAG"
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: 5-UpdateVersionInfo
        run: |
          # ä»æ–°æ ‡ç­¾ä¸­æå–ç‰ˆæœ¬å·ï¼ˆå»é™¤vå‰ç¼€å’Œ-autoåç¼€ï¼‰
          VERSION_NAME=$(echo "${{ env.NEW_TAG }}" | sed 's/^v//; s/-auto$//')
          echo "Updating version name to: $VERSION_NAME"
          # æ›´æ–°appæ¨¡å—çš„build.gradleä¸­çš„ç‰ˆæœ¬å·
          LATEST_OPENLIST_VERSION=$VERSION_NAME-auto
          sed -i "s/versionName \".*\"/versionName \"$LATEST_OPENLIST_VERSION\"/" app/build.gradle
          # æ›´æ–° OpenList ç‰ˆæœ¬å·
          echo "SET OPENLIST VERSION TO" ${LATEST_OPENLIST_VERSION}
          sed -i "s/\(public static String OPENLIST_VERSION = \"\)\([^\";]*\)\(\";\)/\1${LATEST_OPENLIST_VERSION}\3/" app/src/main/java/com/leohao/android/alistlite/util/Constants.java

      - name: 6-BuildOpenListArtifacts
        run: |
          cd $GITHUB_WORKSPACE/AListLib/scripts
          sh install_alist.sh
          sh install_gomobile.sh
          sh build_aar.sh

      - name: 7-SetupAndroidSDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
          accept-android-sdk-licenses: true
          packages: 'build-tools;29.0.3 build-tools;30.0.3'

      - name: 8-GrantGradlew
        run: chmod +x gradlew

      - name: 9-BuildAPK
        run: ./gradlew assembleRelease

      - name: 10-SignAPK
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.ANDROID_SIGNING_KEY }}
          alias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: 10.1-CleanupAndRenameAPKs
        run: |
          cd app/build/outputs/apk/release
          echo "ğŸ“¦ Cleaning up intermediate APK files..."
          # åˆ é™¤æœªç­¾åå’Œä»…å¯¹é½çš„APK
          rm -f *unsigned.apk
          rm -f *unsigned-aligned.apk
          
          # é‡å‘½åsigned APKï¼Œå»æ‰"unsigned"å­—æ ·
          echo "ğŸ“ Renaming APK files..."
          for file in *unsigned-signed.apk; do
            if [ -f "$file" ]; then
              newname=$(echo "$file" | sed 's/-unsigned-signed/-signed/')
              mv "$file" "$newname"
              echo "  âœ“ $newname"
            fi
          done
          
          echo "âœ… Cleanup complete. Final files:"
          ls -lh *.apk

      - name: 11-CreateNewTag
        run: |
          git config --global user.email "2867555086@github.com"
          git config --global user.name "LeoHaoVIP"
          git tag ${{ env.NEW_TAG }}
          git push origin ${{ env.NEW_TAG }}

      - name: 12-CreateNewRelease
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          tag_name: ${{ env.NEW_TAG }}
          release_name: Auto Release ${{ env.NEW_TAG }}
          body: |
            Auto-generated release based on ${{ env.NEW_TAG }}
          files: app/build/outputs/apk/release/*${{ env.NEW_TAG }}*.apk
